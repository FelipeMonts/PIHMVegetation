q2<-paste0("SELECT
component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r, comppct_r,
FROM component JOIN chorizon ON component.cokey = chorizon.cokey
AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC", sep="")
res2 <- SDA_query(q2)
q2<-paste0("SELECT
component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r,
sandtotal_r, silttotal_r, claytotal_r, sandvc_r, sandco_r, sandmed_r, sandfine_r, sandvf_r
FROM component JOIN chorizon ON component.cokey = chorizon.cokey
AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC", sep="")
res2 <- SDA_query(q2)
q2<-paste0("SELECT
component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r,
sandtotal_r, silttotal_r, claytotal_r, sandvc_r, sandco_r, sandmed_r, sandfine_r, sandvf_r
FROM component JOIN chorizon ON component.cokey = chorizon.cokey
AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC", sep="")
res2 <- SDA_query(q2)
q2<-paste0("SELECT
component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r,
sandtotal_r, silttotal_r, claytotal_r, sandvc_r, sandco_r, sandmed_r, sandfine_r, sandvf_r
FROM mapunit
LEFT JOIN component ON component.mukey = mapunit.mukey AND mukey IN ", in.statement)
q2
res2 <- SDA_query(q2)
q2<-paste0("SELECT
component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r,
sandtotal_r, silttotal_r, claytotal_r, sandvc_r, sandco_r, sandmed_r, sandfine_r, sandvf_r
FROM mapunit
LEFT JOIN component ON component.mukey = mapunit.mukey AND mukey IN ", in.statement,
"JOIN chorizon ON component.cokey = chorizon.cokey")
q2
res2 <- SDA_query(q2)
q2<-paste0("SELECT
component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r,
sandtotal_r, silttotal_r, claytotal_r, sandvc_r, sandco_r, sandmed_r, sandfine_r, sandvf_r
FROM mapunit
LEFT JOIN component ON component.mukey = mapunit.mukey AND mukey IN ", in.statement,
"LEFT OUTER JOIN component ON component.mukey = mapunit.mukey
LEFT OUTER JOIN chorizon ON ch.cokey = c.cokey")
q2
res2 <- SDA_query(q2)
q2<-paste0("SELECT
component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r,
FROM mapunit
LEFT JOIN component ON component.mukey = mapunit.mukey AND mukey IN ", in.statement,
"LEFT OUTER JOIN component ON component.mukey = mapunit.mukey
LEFT OUTER JOIN chorizon ON ch.cokey = c.cokey")
q2
res2 <- SDA_query(q2)
q2<-paste0("SELECT
component.mukey, component.cokey, compname, comppct_r
FROM mapunit
LEFT JOIN component ON component.mukey = mapunit.mukey AND mukey IN ", in.statement,
"LEFT OUTER JOIN component ON component.mukey = mapunit.mukey
LEFT OUTER JOIN chorizon ON ch.cokey = c.cokey")
q2
res2 <- SDA_query(q2)
q2<-paste0("SELECT
component.mukey, component.cokey, compname, comppct_r
FROM mapunit
LEFT JOIN component ON component.mukey = mapunit.mukey AND mukey IN ", in.statement,
" LEFT OUTER JOIN component ON component.mukey = mapunit.mukey
LEFT OUTER JOIN chorizon ON ch.cokey = c.cokey")
q2
res2 <- SDA_query(q2)
q <- paste("SELECT component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r
FROM component JOIN chorizon ON component.cokey = chorizon.cokey
AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC", sep="")
res <- SDA_query(q)
head(res)
q <- paste0("SELECT
component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r
FROM component JOIN chorizon ON component.cokey = chorizon.cokey
AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
q2 <- paste0("SELECT
component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r
FROM component JOIN chorizon ON component.cokey = chorizon.cokey
AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
q2 <- paste0("SELECT
component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r
FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
q2 <- paste0("SELECT
component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r
FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ",
in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ",
in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
head(res2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, hzdept_r, hzdepb_r, hzname, awc_r, FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r, FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
head(res2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, co.key, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, c.cokey, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
head(res2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
head(res2)
.libPaths("C:/Felipe/Sotware&Coding/R_Library/library")  ;
co.sum.whc <- function(i) {
wt <- i$comppct_r[1] # keep the first component pct (they are all the same)
thick <- with(i, hzdepb_r - hzdept_r) # compute horizon thickness
whc <- thick * i$awc_r # compute water storage by horizon
whc.total <- sum(whc, na.rm=TRUE) # sum to get profile water storage
data.frame(whc=whc.total, wt=wt) # return profile water storage and component pct
}
mu.mean.whc <- function(i) {
whc <- wtd.mean(i$whc, weights=i$wt) # safely compute wt. mean water storage
data.frame(whc=whc) # return wt. mean water storage
}
library(Hmisc)
library(soilDB)
library(plyr)
library(raster)
library(aqp)
data(gSSURGO.chunk, package='soilDB')
gSSURGO.chunk <- ratify(gSSURGO.chunk, count=TRUE)
rat <- levels(gSSURGO.chunk)[[1]]
in.statement <- format_SQL_in_statement(rat$ID)
q <- paste("SELECT component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r
FROM component JOIN chorizon ON component.cokey = chorizon.cokey
AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC", sep="")
res <- SDA_query(q)
head(res)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
head(res2)
co.whc <- ddply(res, c('mukey', 'cokey'), co.sum.whc)
mu.whc <- ddply(co.whc, 'mukey', mu.mean.whc)
head(mu.whc)
names(mu.whc)[1] <- 'ID'
rat.new <- join(rat, mu.whc, type='left')
levels(gSSURGO.chunk) <- rat.new
r.new <- deratify(gSSURGO.chunk, att='whc')
plot(r.new)
library(plyr)
library(raster)
library(foreign)
r <- raster('C:\\Felipe\\PIHM-CYCLES\\PIHM\\PIHM_Felipe\\CNS\\Manhantango\\gssurgo_g_pa\\GSSURGO_PA_TIFF\\MahatangoGSSG1.tif') ;
r <- ratify(r)
rat <- levels(r)[[1]]
rat
in.statement2 <- format_SQL_in_statement(rat$ID)
in.statement2
q3 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement2," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
q3
res3 <- SDA_query(q3)
head(res2)
mu <- read.dbf('C:\\Felipe\\PIHM-CYCLES\\PIHM\\PIHM_Felipe\\CNS\\Manhantango\\gssurgo_g_pa\\GSSURGO_PA_TIFF\\MahatangoGSSG1.tif.vat.dbf') ;
names(mu)[1] <- 'ID'
library(Hmisc)
library(soilDB)
library(plyr)
library(raster)
library(aqp)
install.packages("soilDB", repos="http://R-Forge.R-project.org") # most recent copy from r-forge
install.packages("soilDB", repos = "http://R-Forge.R-project.org")
install.packages("foreign")
install.packages("foreign")
##### Working with the Package AQP #######
##### http://ncss-tech.github.io/AQP/soilDB/gSSURGO-SDA.html#####
#### Felipe Montes 2016 09 09 #############
#  Tell the program where the package libraries are  #####################
.libPaths("C:/Felipe/Sotware&Coding/R_Library/library")  ;
#### Install pakages #####
# function for computing profile-total water storage
co.sum.whc <- function(i) {
wt <- i$comppct_r[1] # keep the first component pct (they are all the same)
thick <- with(i, hzdepb_r - hzdept_r) # compute horizon thickness
whc <- thick * i$awc_r # compute water storage by horizon
whc.total <- sum(whc, na.rm=TRUE) # sum to get profile water storage
data.frame(whc=whc.total, wt=wt) # return profile water storage and component pct
}
# function for computing weighted-mean whc within a map unit
mu.mean.whc <- function(i) {
whc <- wtd.mean(i$whc, weights=i$wt) # safely compute wt. mean water storage
data.frame(whc=whc) # return wt. mean water storage
}
# load libraries
library(Hmisc)
library(soilDB)
library(plyr)
library(raster)
library(aqp)
data(gSSURGO.chunk, package='soilDB')
gSSURGO.chunk <- ratify(gSSURGO.chunk, count=TRUE)
rat <- levels(gSSURGO.chunk)[[1]]
in.statement <- format_SQL_in_statement(rat$ID)
q <- paste("SELECT component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r
FROM component JOIN chorizon ON component.cokey = chorizon.cokey
AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC", sep="")
res <- SDA_query(q)
head(res)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
head(res2)
co.whc <- ddply(res, c('mukey', 'cokey'), co.sum.whc)
mu.whc <- ddply(co.whc, 'mukey', mu.mean.whc)
head(mu.whc)
names(mu.whc)[1] <- 'ID'
rat.new <- join(rat, mu.whc, type='left')
levels(gSSURGO.chunk) <- rat.new
r.new <- deratify(gSSURGO.chunk, att='whc')
plot(r.new)
library(plyr)
library(raster)
library(foreign)
r <- raster('C:\\Felipe\\PIHM-CYCLES\\PIHM\\PIHM_Felipe\\CNS\\Manhantango\\gssurgo_g_pa\\GSSURGO_PA_TIFF\\MahatangoGSSG1.tif') ;
r <- ratify(r) ;
rat <- levels(r)[[1]] ;
in.statement2 <- format_SQL_in_statement(rat$ID)
q3 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement2," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res3 <- SDA_query(q3)
head(res2)
install.packages('raster', dep=TRUE)
install.packages('plyr', dep=TRUE)
install.packages('Hmisc', dep=TRUE)
install.packages('soilDB', dep=TRUE) # stable version from CRAN + dependencies
install.packages("soilDB", repos="http://R-Forge.R-project.org") # most recent copy from r-forge
install.packages("SSOAP", repos = "http://www.omegahat.org/R", type="source") # SSOAP and XMLSchema
install.packages("foreign")
install.packages("httr", dep=TRUE)
install.packages("rgdal", dep = TRUE)
install.packages("raster", dep = TRUE)
install.packages("rgeos", dep = TRUE)
install.packages("raster", dep = TRUE)
install.packages("plyr", dep = TRUE)
install.packages("soilDB", dep = TRUE)
install.packages("soilDB", repos = "http://R-Forge.R-project.org")
install.packages("Hmisc", dep = TRUE)
install.packages("httr", dep = TRUE)
install.packages("rgdal", dep = TRUE)
install.packages("raster", dep = TRUE)
install.packages("soilDB", dep = TRUE)
install.packages("Hmisc", dep = TRUE)
install.packages("rgdal", dep = TRUE)
install.packages("raster", dep = TRUE)
install.packages("soilDB", repos = "http://R-Forge.R-project.org")
install.packages("httr", dep = TRUE)
install.packages("raster", dep = TRUE)
install.packages("soilDB", repos = "http://R-Forge.R-project.org")
install.packages("rgdal", dep = TRUE)
install.packages("httr", dep = TRUE)
install.packages("rgdal", dep = TRUE)
install.packages("httr", dep = TRUE)
##### Working with the Package AQP #######
##### http://ncss-tech.github.io/AQP/soilDB/gSSURGO-SDA.html#####
#### Felipe Montes 2016 09 09 #############
#  Tell the program where the package libraries are  #####################
.libPaths("C:/Felipe/Sotware&Coding/R_Library/library")  ;
# function for computing profile-total water storage
co.sum.whc <- function(i) {
wt <- i$comppct_r[1] # keep the first component pct (they are all the same)
thick <- with(i, hzdepb_r - hzdept_r) # compute horizon thickness
whc <- thick * i$awc_r # compute water storage by horizon
whc.total <- sum(whc, na.rm=TRUE) # sum to get profile water storage
data.frame(whc=whc.total, wt=wt) # return profile water storage and component pct
}
# function for computing weighted-mean whc within a map unit
mu.mean.whc <- function(i) {
whc <- wtd.mean(i$whc, weights=i$wt) # safely compute wt. mean water storage
data.frame(whc=whc) # return wt. mean water storage
}
# load libraries
library(Hmisc)
library(soilDB)
library(plyr)
library(raster)
library(aqp)
library(sp)
library(rgdal)
library(raster)
library(rgeos)
library(lattice)
library(MASS)
# load chunk of gSSURGO
data(gSSURGO.chunk, package='soilDB')
# convert into a raster + RAT
gSSURGO.chunk <- ratify(gSSURGO.chunk, count=TRUE)
# save RAT to new object, will use later
rat <- levels(gSSURGO.chunk)[[1]]
# extract the map unit keys from the RAT, and format for use in an SQL IN-statement
in.statement <- format_SQL_in_statement(rat$ID)
# format query in SQL- raw data are returned
q <- paste("SELECT component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r
FROM component JOIN chorizon ON component.cokey = chorizon.cokey
AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC", sep="")
# now get component and horizon-level data for these map unit keys
res <- SDA_query(q)
head(res)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
head(res2,20)
q3 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r, om_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement2," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
in.statement2 <- format_SQL_in_statement(rat$ID)
q3 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r, om_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement2," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res3 <- SDA_query(q3);
head(res2) ;
res3$id<-res3$mukey ;
res3$top<-res3$hzdept_r ;
res3$bottom<-res3$hzdepb_r ;
res3$name<-res3$hzname ;
depths(res3)<-id ~ top + bottom  ;
str(res3) ;
plot(res3, name='name')
plot(res3, name='name', color='om_r')
q3 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r, om_r,dbtenthbar_r, dbthirdbar_r, dbfifteenbar_r  FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement2," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res3 <- SDA_query(q3);
head(res2) ;
res3$id<-res3$mukey ;
res3$top<-res3$hzdept_r ;
res3$bottom<-res3$hzdepb_r ;
res3$name<-res3$hzname ;
depths(res3)<-id ~ top + bottom  ;
str(res3) ;
plot(res3, name='name', color='dbtenthbar_r')
plot(res3, name='name', color='claytotal_r')
head(res3) ;
plot(res3, name='name', color='dbthirdbar_r')
plot(res3[1:10], name='name', color='dbthirdbar_r')
res3[1]
res3[1:3]
print(res3[1])
print(res3[1:3])
head[res3]
plot(res3[1:3], name='name', color='dbthirdbar_r')
q3 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r, om_r,dbtenthbar_r, dbthirdbar_r, dbfifteenbar_r, fraggt10_r, frag3to10_r, sieveno10_r, sieveno40_r, sieveno200_r  FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement2," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res3 <- SDA_query(q3);
head(res3) ;
res3$id<-res3$mukey ;
res3$top<-res3$hzdept_r ;
res3$bottom<-res3$hzdepb_r ;
res3$name<-res3$hzname ;
depths(res3)<-id ~ top + bottom  ;
str(res3) ;
plot(res3[1:10], name='name', color='dbthirdbar_r')
plot(res3[1:10], name='name', color='frag3to10_r')
install.packages("dplyr")
.libPaths("C:/Felipe/Sotware&Coding/R_Library/library")  ;
install.packages("dplyr")
# load libraries
library(Hmisc) ;
library(soilDB) ;
library(plyr) ;
library(raster) ;
library(aqp) ;
library(sp) ;
library(rgdal) ;
library(raster) ;
library(rgeos) ;
library(lattice) ;
library(MASS) ;
library(RColorBrewer) ;
library(ggplot2)  ;
#library(tmap) ;
library(dplyr)  ;
library(tidyr)  ;
library(devtools) ;
sessionInfo()
########################## import the raster file with the GSSURGO Data for the watershed in PIHM ####################
Manhatango_GSSURGO<- raster('C:\\Felipe\\PIHM-CYCLES\\PIHM\\PIHM_Felipe\\CNS\\Manhantango\\gssurgo_g_pa\\GSSURGO_PA_TIFF\\MahatangoGSSG1.tif') ;
# generate a RAT via raster package functionality
Manhatango_GSSURGO <- ratify(Manhatango_GSSURGO) ;
# extract RAT to a data.frame
MUKEYS <- levels(Manhatango_GSSURGO)[[1]] ;
################################ Query the Soil Data access database with SQL through R #################
# from https://sdmdataaccess.sc.egov.usda.gov/queryhelp.aspx
# and https://sdmdataaccess.sc.egov.usda.gov/documents/ReturningSoilTextureRelatedAttributes.pdf
# --Sample query begins.
# --Note that a pair of dashes denotes the beginning of a comment.
# SELECT
# saversion, saverest, -- attributes from table "sacatalog"
# l.areasymbol, l.areaname, l.lkey, -- attributes from table "legend"
# musym, muname, museq, mu.mukey, -- attributes from table "mapunit"
# comppct_r, compname, localphase, slope_r, c.cokey, -- attributes from table "component"
# hzdept_r, hzdepb_r, ch.chkey, -- attributes from table "chorizon"
# sandtotal_r, silttotal_r, claytotal_r, --total sand, silt and clay fractions from table "chorizon"
# sandvc_r, sandco_r, sandmed_r, sandfine_r, sandvf_r,--sand sub-fractions from table "chorizon"
# texdesc, texture, stratextsflag, chtgrp.rvindicator, -- attributes from table "chtexturegrp"
# texcl, lieutex, -- attributes from table "chtexture"
# texmod -- attributes from table "chtexturemod"
# FROM sacatalog sac
# INNER JOIN legend l ON l.areasymbol = sac.areasymbol AND l.areatypename = 'Non-MLRA Soil Survey Area'
# INNER JOIN mapunit mu ON mu.lkey = l.lkey
# AND mu.mukey IN
# ('107559','107646','107674','107682','107707','107794','107853','107854','107865','107867','107869','107870','107871')
# LEFT OUTER JOIN component c ON c.mukey = mu.mukey
# LEFT OUTER JOIN chorizon ch ON ch.cokey = c.cokey
# LEFT OUTER JOIN chtexturegrp chtgrp ON chtgrp.chkey = ch.chkey
# LEFT OUTER JOIN chtexture cht ON cht.chtgkey = chtgrp.chtgkey
# LEFT OUTER JOIN chtexturemod chtmod ON chtmod.chtkey = cht.chtkey
# --WHERE.
# --ORDER BY l.areaname, museq, comppct_r DESC, compname, hzdept_r -- standard soil report ordering
# --Sample query ends.
# extract the map unit keys from the RAT, and format for use in an SQL IN-statement
in.statement2 <- format_SQL_in_statement(MUKEYS$ID)
# format query in SQL- raw data are returned
Pedon.query<- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r,hzthk_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r, om_r,dbtenthbar_r, dbthirdbar_r, dbfifteenbar_r, fraggt10_r, frag3to10_r, sieveno10_r, sieveno40_r, sieveno200_r, ksat_r  FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement2," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
# now get component and horizon-level data for these map unit keys
Pedon.info<- SDA_query(Pedon.query);
head(Pedon.info) ;
# filter components that are the major components of each unit map with the Flag majcompflag=='Yes'
Pedon.info.MajorC<-Pedon.info[which(Pedon.info$majcompflag == 'Yes'),]  ;
head(Pedon.info.MajorC) ;
# check if there are mukeys with more than one dominant component
Pedon.info.MajorC$mukey.factor<-as.factor(Pedon.info.MajorC$mukey) ;
Pedon.info.MajorC$cokey.factor<-as.factor(Pedon.info.MajorC$cokey) ;
Pedon.info.MajorC$mukey_comppct_r<-paste(Pedon.info.MajorC$mukey.factor,Pedon.info.MajorC$comppct_r, sep = "_") ;
# Select major component mukeys that have also the highest component percent comppct_r
head(Pedon.info.MajorC)
Dominant<- aggregate(comppct_r ~ mukey.factor, data=Pedon.info.MajorC, FUN="max" , drop=T, simplify=T) ;
head(Dominant)
Dominant$mukey_comppct_r<-paste(Dominant$mukey.factor,Dominant$comppct_r, sep ="_");
Mukey.Pedon<-Pedon.info.MajorC[Pedon.info.MajorC$mukey_comppct_r %in% Dominant$mukey_comppct_r,]
data(sp4)
depths(sp4) <- id ~ top + bottom
slice(sp4, fm= 0:15 ~ sand + silt + clay + name + ex_Ca_to_Mg)
sessionInfo()
install.packages("aqp")
install.packages("aqp")
install.packages("aqp")
#################### Program to change Land cover indices from Hydroterre to the MM-PIHM format##################
#################### Felipe Montes                             ##########################
###############################################################################################################
#                          Loading Packages and setting up working directory
###############################################################################################################
#  Tell the program where the package libraries are  #####################
.libPaths("C:/Felipe/Sotware&Coding/R_Library/library")  ;
#  Set Working directory
setwd("C:/Felipe/PIHM-CYCLES/PIHM/PIHM_R_Scripts/PIHMVegetation") ;
########### Install packages  #####################
NUMLC<-read.table("./vegprmt.tbl", skip=0, as.is=T, nrows=1) ;
vegprmt.tbl<-read.table("./vegprmt.tbl", skip=1, sep="", as.is=T, header=T, nrows=NUMLC[1,2]) ;
Description<-read.table("./vegprmt.tbl", skip=1, sep="\t", as.is=T, header=T, nrows=NUMLC[1,2], comment.char="") ;
vegprmt.tbl$Description<-sapply(strsplit(Description[,1], "#"), "[" , 2) ;
Otherprmt.tbl<-read.table("./vegprmt.tbl", skip=NUMLC[1,2]+2, sep="", as.is=T, header=F, nrows=5) ;
NLCD_PIHM.lc<-read.table("./vegprmt.tbl", skip=NUMLC[1,2]+10, sep= ">" , as.is=T, header=F,comment.char="") ;
PIHM.lc<-NLCD_PIHM.lc[,2];
NLCD.lc<-as.integer(sapply(strsplit(NLCD_PIHM.lc[,1], split = " "), "[" , 2)) ;
NLCD_to_PIHM<-merge(data.frame(NLCD.lc, PIHM.lc), vegprmt.tbl, by.x= "PIHM.lc", by.y= "INDEX", all=T) ;
att<-read.table("C:/Felipe/PIHM-CYCLES/PIHM/PIHM_Felipe/CNS/Manhantango/HydroTerreFullManhantango/HansYostDeepCreek/Aug2920171550/4DataModelLoader/MergeVectorLayer000_q30_a200000.att",as.is=T,col.names=c('Index', 'Soil', 'Geol','LC','IS_IC', 'Snw_IC', 'Srf_IC', 'Ust_IC', 'St_IC', 'Ppt', 'Tmp', 'RH', 'Wnd', 'Rn', 'G', 'VP', 'S', 'mF', 'BC.0', 'BC.1', 'BC.2', 'mP'));
att
str(NLCD_to_PIHM)
str(att)
NLCD_to_PIHM
NLCD_to_PIHM[!is.na(NLCD_to_PIHM$NLCD.lc,]
######### Load the attribute file to change the LC codes from NLCD to the NEw PIHM
att<-read.table("C:/Felipe/PIHM-CYCLES/PIHM/PIHM_Felipe/CNS/Manhantango/HydroTerreFullManhantango/HansYostDeepCreek/Aug2920171550/4DataModelLoader/MergeVectorLayer000_q30_a200000.att",as.is=T,col.names=c('Index', 'Soil', 'Geol','LC','IS_IC', 'Snw_IC', 'Srf_IC', 'Ust_IC', 'St_IC', 'Ppt', 'Tmp', 'RH', 'Wnd', 'Rn', 'G', 'VP', 'S', 'mF', 'BC.0', 'BC.1', 'BC.2', 'mP'));
######### MErge with the NLCD_to_PIHM data to change the NLCD LC data to the MM-PIHM Land Cover
merge(att,NLCD_to_PIHM, by.x="" )
NLCD_to_PIHM[!is.na(NLCD_to_PIHM$NLCD.lc),]
merge(att,NLCD_to_PIHM, by.x="LC", by.y="NLCD.lc", all.x=T )
merge(att,NLCD_to_PIHM, by.x="LC", by.y="NLCD.lc", all.x=T ) [,c("PIHM.lc", "LC")];
att
NLCD_to_PIHM
NLCD_to_PIHM
att
merge(att,NLCD_to_PIHM, by.x="LC", by.y="NLCD.lc", all.x=T ) [,c("NLCD.lc", "LC","PIHM.lc")];
merge(att,NLCD_to_PIHM, by.x="LC", by.y="NLCD.lc", all.x=T ) [,c( "LC","PIHM.lc")];
str(merge(att,NLCD_to_PIHM, by.x="LC", by.y="NLCD.lc", all.x=T ) ) ;
str(att)
att.expanded<-merge(att,NLCD_to_PIHM, by.x="LC", by.y="NLCD.lc", all.x=T ) ;
names(att)
names(att)
names(att)[4]
revised.names<-names(att)   ;
revised.names
revised.names[4]
revised.names[4]<- " PIHM.lc" ;
revised.names
revised.names[4]<- "PIHM.lc" ;
revised.names
Revised.att<-att.expanded[revised.names,]
Revised.att
Revised.att<-att.expanded[,revised.names] ;
Revised.att
names(Revised.att)[4]<-'LC'  ;
Revised.att
write.table(Revised.att[,c('Index', 'Soil', 'Geol','LC','IS_IC', 'Snw_IC', 'Srf_IC', 'Ust_IC', 'St_IC', 'Ppt', 'Tmp', 'RH', 'Wnd', 'Rn', 'G', 'VP', 'S', 'mF', 'BC.0', 'BC.1', 'BC.2', 'mP')], file="C:/Felipe/PIHM-CYCLES/PIHM/PIHM_Felipe/CNS/Manhantango/HydroTerreFullManhantango/HansYostDeepCreek/Aug2920171550/4DataModelLoader/Revised.att" , row.names=F, quote=F , sep = "\t" ) ; # ,col.names=header.att, quote=F
Revised.att<-att.expanded[order("Index"),revised.names] ;
Revised.att
Revised.att<-att.expanded[order(att.expanded$Index),revised.names] ;
Revised.att
names(Revised.att)[4]<-'LC'  ;
att.expanded<-merge(att,NLCD_to_PIHM, by.x="LC", by.y="NLCD.lc", all.x=T ) ;
revised.names<-names(att)   ;
revised.names[4]<- "PIHM.lc" ;
Revised.att<-att.expanded[order(att.expanded$Index),revised.names] ;
names(Revised.att)[4]<-'LC'  ;
Revised.att
write.table(Revised.att[,c('Index', 'Soil', 'Geol','LC','IS_IC', 'Snw_IC', 'Srf_IC', 'Ust_IC', 'St_IC', 'Ppt', 'Tmp', 'RH', 'Wnd', 'Rn', 'G', 'VP', 'S', 'mF', 'BC.0', 'BC.1', 'BC.2', 'mP')], file="C:/Felipe/PIHM-CYCLES/PIHM/PIHM_Felipe/CNS/Manhantango/HydroTerreFullManhantango/HansYostDeepCreek/Aug2920171550/4DataModelLoader/Revised.att" , row.names=F, quote=F , sep = "\t" ) ; # ,col.names=header.att, quote=F
